<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Vehículos Disponibles</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .filters { margin-bottom: 20px; }
        .filters select, .filters button { padding: 5px; margin-right: 10px; }
        .actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .actions a { margin-left: 15px; margin-right: 0; text-decoration: none; color: #007BFF; }
    </style>
</head>
<body>

<div class="actions" style="position: absolute; top: 20px; right: 20px;">
    <a href="{{ url_for('login') }}">Descargar Excel Actualizado</a>
    {% if session.logged_in %}
        <a href="{{ url_for('logout') }}">Cerrar sesión</a>
    {% endif %}
</div>

<h1>Vehículos Disponibles</h1>


<div class="filters">
    <form method="get" action="{{ url_for('index') }}">
        <label>División:
            <select name="division" onchange="this.form.submit()">
                <option value="">Todas</option>
                {% for d in divisiones %}
                <option value="{{ d }}" {% if d == selected_division %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Brigada:
            <select name="brigada" onchange="this.form.submit()" {% if not selected_division %}disabled{% endif %}>
                <option value="">Todas</option>
                {% for b in brigadas %}
                <option value="{{ b }}" {% if b == selected_brigada %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Unidad:
            <select name="unidad" onchange="this.form.submit()" {% if not selected_brigada %}disabled{% endif %}>
                <option value="">Todas</option>
                {% for u in unidades %}
                <option value="{{ u }}" {% if u == selected_unidad %}selected{% endif %}>{{ u }}</option>
                {% endfor %}
            </select>
        </label>

        <button type="submit">Filtrar</button>
    </form>
    <form method="get" action="{{ url_for('index') }}" style="margin-top: 10px;">
        <label>Buscar por placa:
            <input type="text" name="placa" placeholder="Ingrese la placa" value="{{ request.args.get('placa', '') }}" style="padding: 5px;">
        </label>
        <button type="submit" style="padding: 5px;">Buscar</button>
    </form>
</div>

<table>
    <thead>
        <tr>
            <th>ORD</th>
            <th>Marca</th>
            <th>Clase / Tipo</th>
            <th>Año</th>
            <th>Placas</th>
            <th>Color</th>
            <th>Condición</th>
            <th>Estado</th>
            <th>Observación</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody id="table-body">
        <!-- filas se inyectan por JS -->
    </tbody>
</table>

<div id="pagination" style="margin-top: 10px; display:flex; gap:8px; align-items:center;">
    <button id="prev-btn">Anterior</button>
    <span id="page-info"></span>
    <button id="next-btn">Siguiente</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const perPage = 50;
    let currentPage = 1;

    // Leer filtros desde la UI
    function getFilters() {
        const params = new URLSearchParams();
        const division = document.querySelector('select[name="division"]').value;
        const brigada = document.querySelector('select[name="brigada"]').value;
        const unidad = document.querySelector('select[name="unidad"]').value;
        const placa = document.querySelector('input[name="placa"]').value;
        if (division) params.append('division', division);
        if (brigada) params.append('brigada', brigada);
        if (unidad) params.append('unidad', unidad);
        if (placa) params.append('placa', placa);
        return params;
    }

    async function fetchPage(page=1) {
        currentPage = page;
        const params = getFilters();
        params.set('page', page);
        params.set('per_page', perPage);
        const resp = await fetch('/api/vehiculos?' + params.toString());
        if (!resp.ok) { alert('Error al obtener datos'); return; }
        const data = await resp.json();
        renderTable(data.vehicles);
        updatePagination(data.total, data.page, data.per_page);
    }

    function renderTable(rows) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        for (const v of rows) {
            const tr = document.createElement('tr');

            // Crear columnas y formulario en una celda de acción
            tr.innerHTML = `
                <td>${v['ORD']}</td>
                <td>${v['MARCA']}</td>
                <td>${v['CLASE / TIPO']}</td>
                <td>${v['ANO'] || ''}</td>
                <td>${v['PLACAS']}</td>
                <td>${v['COLOR']}</td>
                <td>
                    <select class="condicion">
                        <option value="OPERABLE" ${v['CONDICION']==='OPERABLE' ? 'selected' : ''}>OPERABLE</option>
                        <option value="NO OPERABLE" ${v['CONDICION']==='NO OPERABLE' ? 'selected' : ''}>NO OPERABLE</option>
                        <option value="REMATE" ${v['CONDICION']==='REMATE' ? 'selected' : ''}>REMATE</option>
                    </select>
                </td>
                <td>
                    <select class="estado">
                        <option value="" ${!v['ESTADO'] ? 'selected' : ''}></option>
                        <option value="SERVIBLE" ${v['ESTADO']==='SERVIBLE' ? 'selected' : ''}>SERVIBLE</option>
                        <option value="INSERVIBLE" ${v['ESTADO']==='INSERVIBLE' ? 'selected' : ''}>INSERVIBLE</option>
                        <option value="MANTENIMIENTO" ${v['ESTADO']==='MANTENIMIENTO' ? 'selected' : ''}>MANTENIMIENTO</option>
                        <option value="MUSEO" ${v['ESTADO']==='MUSEO' ? 'selected' : ''}>MUSEO</option>
                    </select>
                </td>
                <td><input type="text" class="observacion" value="${(v['OBSERVACION']||'').replace(/"/g,'&quot;')}" style="width:120px;"></td>
                <td><button class="save-btn">Guardar</button></td>
            `;
            tbody.appendChild(tr);

            // Añadir handler al botón Guardar
            tr.querySelector('.save-btn').addEventListener('click', async () => {
                const ord = v['ORD'];
                const condicion = tr.querySelector('.condicion').value;
                const estado = tr.querySelector('.estado').value;
                const observacion = tr.querySelector('.observacion').value;
                const formData = new FormData();
                formData.append('ord', ord);
                formData.append('condicion', condicion);
                formData.append('estado', estado);
                formData.append('observacion', observacion);
                try {
                    const res = await fetch('{{ url_for("editar_vehiculo") }}', { method: 'POST', body: formData });
                    if (res.ok) {
                        alert('Cambios guardados');
                        // invalidar caché en servidor ya hecho; refrescar la página actual
                        fetchPage(currentPage);
                    } else {
                        alert('Error al guardar');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error al guardar');
                }
            });
        }
    }

    function updatePagination(total, page, per_page) {
        const pageInfo = document.getElementById('page-info');
        const totalPages = Math.max(1, Math.ceil(total / per_page));
        pageInfo.textContent = `Página ${page} de ${totalPages} — ${total} registros`;
        document.getElementById('prev-btn').disabled = page <= 1;
        document.getElementById('next-btn').disabled = page >= totalPages;
    }

    document.getElementById('prev-btn').addEventListener('click', () => { if (currentPage>1) fetchPage(currentPage-1); });
    document.getElementById('next-btn').addEventListener('click', () => { fetchPage(currentPage+1); });

    // Interceptar formulario de filtros (evitar recarga)
    document.querySelectorAll('form[action="{{ url_for("index") }}"]').forEach(f => {
        f.addEventListener('submit', function(e) {
            e.preventDefault();
            fetchPage(1);
        });
    });
    // También interceptar selects con onchange que antes hacían submit
    document.querySelectorAll('.filters select').forEach(s => {
        s.addEventListener('change', () => fetchPage(1));
    });

    // Cargar primera página al inicio
    fetchPage(1);
});
</script>

</body>
</html>